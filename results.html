<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Natijalar</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#f3f4f6;
  padding:20px;
}
.card{
  background:#fff;
  padding:20px;
  border-radius:16px;
  max-width:1100px;
  margin:auto;
}
h2{margin-top:0}
button{
  padding:10px 14px;
  margin-right:8px;
  border:none;
  border-radius:8px;
  background:#4f46e5;
  color:#fff;
  font-weight:bold;
  cursor:pointer;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}
th,td{
  padding:8px;
  border:1px solid #ddd;
  text-align:center;
  font-size:14px;
}
th{
  background:#4f46e5;
  color:#fff;
}
.best{
  background:#dcfce7;
  font-weight:bold;
}
</style>
</head>
<body>

<div class="card">
<h2>üìä Test natijalari</h2>

<div id="stats"></div>

<br>
<button onclick="exportExcel()">‚¨á Excel</button>
<button onclick="window.print()">‚¨á PDF</button>

<canvas id="chart" height="120"></canvas>

<table>
<thead>
<tr>
  <th>#</th>
  <th>Ism</th>
  <th>Familiya</th>
  <th>Test ID</th>
  <th>Fan</th>
  <th>Ball</th>
  <th>Toifa</th>
  <th>Sana</th>
  <th>Status</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<script>
let results = JSON.parse(localStorage.getItem("results")) || [];

// ------------------ ENG YAXSHI NATIJA ------------------
const bestMap = {};
results.forEach(r=>{
  const key = r.ism + "_" + r.familiya + "_" + r.testId;
  if(!bestMap[key] || r.ball > bestMap[key].ball){
    bestMap[key] = r;
  }
});

results = results.map(r=>{
  const key = r.ism + "_" + r.familiya + "_" + r.testId;
  r.best = (bestMap[key] === r);
  return r;
});

// ------------------ JADVAL ------------------
const tbody = document.getElementById("tbody");
results.forEach((r,i)=>{
  tbody.innerHTML += `
  <tr class="${r.best ? 'best' : ''}">
    <td>${i+1}</td>
    <td>${r.ism}</td>
    <td>${r.familiya}</td>
    <td>${r.testId}</td>
    <td>${r.fan}</td>
    <td>${r.ball}</td>
    <td>${r.toifa}</td>
    <td>${r.sana}</td>
    <td>${r.best ? '‚≠ê Eng yaxshi' : ''}</td>
  </tr>`;
});

// ------------------ STATISTIKA ------------------
const total = results.length;
const avg = total
  ? (results.reduce((s,r)=>s+r.ball,0)/total).toFixed(1)
  : 0;

document.getElementById("stats").innerHTML = `
<b>Jami topshirishlar:</b> ${total}<br>
<b>O‚Äòrtacha ball:</b> ${avg}
`;

// ------------------ DIAGRAMMA ------------------
const counts = {
  "O‚Äòtilmadi":0,
  "Ikkinchi toifa":0,
  "Birinchi toifa":0,
  "Oliy toifa":0
};

results.forEach(r=>counts[r.toifa]++);

new Chart(document.getElementById("chart"),{
  type:"bar",
  data:{
    labels:Object.keys(counts),
    datasets:[{
      label:"O‚Äòquvchilar soni",
      data:Object.values(counts),
      backgroundColor:["#fecaca","#fed7aa","#fef08a","#bfdbfe"]
    }]
  }
});

// ------------------ EXCEL ------------------
function exportExcel(){
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.table_to_sheet(document.querySelector("table"));
  XLSX.utils.book_append_sheet(wb, ws, "Natijalar");
  XLSX.writeFile(wb, "test_natijalari.xlsx");
}
</script>

</body>
</html>
